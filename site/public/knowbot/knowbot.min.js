(function(){const KB=window.KnowBot||{};let st={siteId:null,api:null,open:false};
function el(t,p={},c=[]){const e=document.createElement(t);Object.assign(e,p);c.forEach(x=>e.appendChild(x));return e}
function row(txt,cls){return el("div",{className:"kb-row "+cls,innerText:txt},[])}
function hint(txt){const d=el("div",{className:"kb-row kb-hint"});d.innerText=txt;return d}
function mount(){
  if(document.getElementById("kb-root"))return;
  const root=el("div",{id:"kb-root"},[]);
  const panel=el("div",{className:"kb-panel"},[
    el("div",{className:"kb-header",innerText:"Buchanan Vault Assistant"}),
    el("div",{className:"kb-body",id:"kb-body"},[
      hint("Try: “Open bibliography for assemblage 2000–2010” or “Copy Wikipedia block”.")
    ]),
    el("div",{className:"kb-input"},[
      el("input",{id:"kb-in",placeholder:"Ask about Buchanan, Deleuze…"},[]),
      el("button",{className:"kb-btn",innerText:"Send",onclick:send},[])
    ])
  ]);
  const btn=el("button",{className:"kb-btn",innerText:"Ask Vault",onclick:()=>{panel.style.display=st.open?"none":"block";st.open=!st.open}},[]);
  root.appendChild(panel);root.appendChild(btn);document.body.appendChild(root);
}
async function send(){
  const input=document.getElementById("kb-in");const msg=input.value.trim();if(!msg)return;
  const body=document.getElementById("kb-body");body.appendChild(row(msg,"user"));input.value="";
  try{
    const r=await fetch(`${st.api}/query`,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({siteId:st.siteId,msg})});
    const j=await r.json();
    if(j.needsTool && j.call){
      if(j.call.name==="openBibliography"){
        const u=new URL("/bibliography",location.origin);
        if(j.call.args?.query)u.searchParams.set("q",j.call.args.query);
        if(j.call.args?.type)u.searchParams.set("type",j.call.args.type);
        if(j.call.args?.yearMin)u.searchParams.set("ymin",j.call.args.yearMin);
        if(j.call.args?.yearMax)u.searchParams.set("ymax",j.call.args.yearMax);
        window.open(u.toString(),"_blank");
      }else if(j.call.name==="copyWikiBlock"){
        const text=j.call.args?.selection||"";const ok=!j.confirm||confirm(j.draft||"Copy Wiki block?");
        if(ok && text) await navigator.clipboard.writeText(text);
      }
    }
    body.appendChild(row(j.answer||"…","ai"));
    if(j.citations){j.citations.forEach(c=>body.appendChild(row(`↗ ${c.title||c.url}`,"ai")))}
  }catch(e){console.error(e);body.appendChild(row("Sorry, the knowledge API isn’t reachable right now.","ai"))}
}
KB.init=function(opts){st.siteId=opts.siteId;st.api=opts.api;mount();}
window.KnowBot=KB;})();
